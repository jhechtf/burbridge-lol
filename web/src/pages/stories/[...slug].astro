---
import { getPayloadInstance } from "$lib/util";
import { RichText } from "@payload-bites/astro-richtext-renderer";
import Main from "../../layouts/main.astro";

export async function getStaticPaths() {
  const payload = await getPayloadInstance();
  const stories = await payload.find({
    collection: "stories",
    limit: 0,
    draft: import.meta.env.DEV,
    populate: {
      chapters: {
        chapterNumber: true,
        slug: true,
        title: true,
        contents: true,
      },
    },
    sort: [
      'chapters.chapterNumber'
    ],
    pagination: false,
  });

  console.info('RAW', stories.docs.map(doc => doc.chapters));

  const mappedStories = stories.docs.flatMap((story) =>
    story.chapters.map((chapter) => ({
      params: {
        slug: `${story.slug}/${chapter.slug}`,
      },
      props: {
        story: story,
        contents: chapter.contents,
        chapterTitle: chapter.title,
        chapterNumber: chapter.chapterNumber,
      },
    })),
  );


  return mappedStories;
}

const { story, contents, chapterTitle, chapterNumber } = Astro.props;
const { slug } = Astro.params;
---

<Main>
  <div
    class="lg:col-span-6 md:col-span-8 md:col-start-3 lg:col-start-4 col-span-12 px-6 md:px-0 pb-10"
  >
    <h1 class="title text-4xl text-center font-sans font-bold my-4">
      {story.title}
    </h1>
    <h2 class="chapter-title text-2xl text-center my-3 text-zinc-300">
      {chapterTitle ? chapterTitle : `Chapter ${chapterNumber}`}
    </h2>

    <RichText data={contents} />
  </div>
  <div class="hidden md:block md:col-span-2">
    <ol class="mt-9 ml-4 sticky top-20">
      {
        story.chapters.map((chapter) => (
          <li class={slug.endsWith(chapter.slug) ? "font-bold" : undefined}>
            <a href={`/stories/${story.slug}/${chapter.slug}`}>
              {chapter.title}
            </a>
          </li>
        ))
      }
    </ol>
  </div>
</Main>

<style is:global>
  @reference '#app.css';
  p {
    line-height: theme("spacing.4");
  }
  p + p {
    text-indent: theme("spacing.6");
    margin-top: theme("spacing.4");
    line-height: theme("spacing.6");
  }

  blockquote {
    @apply italic;
    padding-inline: 0.75rem;
    margin-block: --spacing(6);
    p + p {
      margin-block-start: --spacing(4);
    }
  }

  hr {
    color: color-mix(in srgb, transparent 50%, currentColor);
  }
</style>
